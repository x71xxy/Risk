{% extends "admin/base.html" %} {% import "macros.html" as macros %} {% block
admin_content %}
<div class="evaluations-container">
  <h2>评估管理</h2>

  <div class="evaluations-table">
    <table>
      <thead>
        <tr>
          <th>ID</th>
          <th>用户</th>
          <th>物品名称</th>
          <th>类别</th>
          <th>提交时间</th>
          <th>状态</th>
          <th>操作</th>
        </tr>
      </thead>
      <tbody>
        {% for evaluation in evaluations.items %}
        <tr>
          <td>{{ evaluation.id }}</td>
          <td>{{ evaluation.user.username }}</td>
          <td>{{ evaluation.title }}</td>
          <td>{{ evaluation.get_category_display() }}</td>
          <td>{{ evaluation.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
          <td>
            <span class="status-badge {{ evaluation.status }}">
              {{ evaluation.get_status_display() }}
            </span>
          </td>
          <td>
            <select
              class="status-select"
              onchange="updateStatus({{ evaluation.id }}, this.value)"
            >
              {% for status, display in evaluation.STATUS_CHOICES.items() %}
              <option value="{{ status }}" {% if status == evaluation.status
              %}selected{% endif %}>
                {{ display }}
              </option>
              {% endfor %}
            </select>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  {{ macros.render_pagination(evaluations) }}
</div>

<style>
  .evaluations-table {
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    overflow: hidden;
  }

  table {
    width: 100%;
    border-collapse: collapse;
  }

  th,
  td {
    padding: 1rem;
    text-align: left;
    border-bottom: 1px solid #e2e8f0;
  }

  th {
    background: #f8fafc;
    font-weight: 500;
  }

  .status-badge {
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-size: 0.875rem;
  }

  .status-badge.pending {
    background: #fef3c7;
    color: #92400e;
  }

  .status-badge.in_progress {
    background: #dbeafe;
    color: #1e40af;
  }

  .status-badge.completed {
    background: #dcfce7;
    color: #166534;
  }

  .status-badge.cancelled {
    background: #fee2e2;
    color: #991b1b;
  }

  .status-select {
    padding: 0.5rem;
    border: 1px solid #e2e8f0;
    border-radius: 4px;
    background: white;
  }
</style>

<script>
function updateStatus(evaluationId, status) {
  fetch(`/admin/evaluation/${evaluationId}/update`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': '{{ csrf_token() }}'
    },
    body: JSON.stringify({ status: status })
  })
  .then(response => {
    if (!response.ok) throw new Error('更新失败');
    return response.json();
  })
  .then(data => {
    if (data.message) {
      location.reload();
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('更新状态失败，请重试');
  });
}
</script>
{% endblock %}
